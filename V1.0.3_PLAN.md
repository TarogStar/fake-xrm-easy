# v1.0.3 Implementation Plan - Comprehensive Improvements

**Based on:** UPSTREAM_REVIEW.md analysis
**Status:** In Progress
**Target Release:** v1.0.3

---

## Implementation Strategy

Given the scope across all 4 option areas, we'll implement in priority order based on:
1. **Impact** - How many users affected
2. **Effort** - Time required
3. **Risk** - Complexity and potential for breaking changes

---

## PHASE 1: Critical Quick Wins (Est: 4-6 hours)

### 1.1 Between Dates Query Fix (#588) ⏱️ 1 hour
**Status:** Ready to implement
**Files:** `XrmFakedContext.Queries.cs`

**Problem:**
Between dates queries don't include the full end day (stops at midnight instead of 23:59:59.999)

**Solution:**
```csharp
// In TranslateConditionExpressionBetweenDates, change lines like:
toDate = new DateTime(thisYear, 12, 31);
// To:
toDate = new DateTime(thisYear, 12, 31, 23, 59, 59, 999);
```

**Impact:** HIGH - Common date range pattern
**Test:** Create test with date range crossing day boundaries

---

### 1.2 EntityReference.Name Population (#555) ⏱️ 2-3 hours
**Status:** Ready to implement
**Files:** `RetrieveRequestExecutor.cs`, `RetrieveMultipleRequestExecutor.cs`

**Problem:**
Retrieved EntityReferences don't have Name property populated

**Solution:**
When retrieving entities, populate Name on EntityReference attributes from the referenced entity's primary name attribute.

**Impact:** MEDIUM - Used for display purposes
**Test:** Retrieve with lookup, verify Name populated

---

### 1.3 Null Reference Fixes (#608, #607) ⏱️ 2-4 hours
**Status:** Needs investigation
**Files:** Query engine, LIKE operator handling

**Problem:**
Null reference exceptions in LIKE conditions and other operators

**Solution:**
Add defensive null checks throughout query translation

**Impact:** HIGH - Prevents crashes
**Test:** Add null value tests for all operators

---

## PHASE 2: Date/Time Robustness (Est: 6-8 hours)

### 2.1 ThisMonth/LastMonth Fixes (#587, #551) ⏱️ 4-6 hours
**Status:** Needs deep investigation
**Files:** `XrmFakedContext.Queries.cs` (TranslateConditionExpressionBetweenDates)

**Problems:**
- ThisMonth fails on month-end afternoons
- LastMonth ignores time portions
- No UTC timezone handling

**Solution:**
1. Fix date range calculations for ThisMonth, LastMonth
2. Add UTC timezone conversion support
3. Ensure time portions handled correctly

**Impact:** VERY HIGH - Fundamental date queries
**Tests:** Month-end edge cases, timezone scenarios

---

### 2.2 Week Operators (#543) ⏱️ 2-3 hours
**Status:** Needs investigation
**Files:** `XrmFakedContext.Queries.cs`

**Problem:**
ThisWeek, LastWeek, NextWeek failing tests

**Solution:**
Fix week calculation logic, ensure proper week boundaries

**Impact:** MEDIUM
**Tests:** Week boundary tests

---

## PHASE 3: Query Engine Improvements (Est: 8-12 hours)

### 3.1 FetchXML Multiple Filters (#507) ⏱️ 4-6 hours
**Status:** PR exists to review
**Files:** FetchXML translation

**Problem:**
FetchXML with multiple filter nodes not translated correctly

**Solution:**
Review PR #507 and implement proper multiple filter handling

**Impact:** HIGH - Core FetchXML feature
**Tests:** Complex multi-filter FetchXML queries

---

### 3.2 Left Outer Join Fixes (#503) ⏱️ 3-4 hours
**Status:** PR exists to review
**Files:** Query translation, join handling

**Problem:**
Left outer joins fail or return incorrect results

**Solution:**
Review PR #503 and fix join operation handling

**Impact:** HIGH - Joins are fundamental
**Tests:** Various left outer join scenarios

---

### 3.3 Complex Nested Filters (#584, #545, #547) ⏱️ 4-6 hours
**Status:** Needs deep investigation
**Files:** Query translation engine

**Problems:**
- Nested entity filters fail
- Aggregates don't work with nested outer joins
- Null operators broken in nested filters

**Solution:**
Comprehensive query engine review and fixes

**Impact:** HIGH - Complex queries
**Tests:** Nested filter scenarios

---

## PHASE 4: Advanced Messages (Est: 12-16 hours)

### 4.1 ExecuteTransactionRequest (#610) ⏱️ 4-6 hours
**Status:** Design needed
**Files:** New message executor

**Problem:**
No support for transactional request wrapping

**Solution:**
- Create ExecuteTransactionRequest/Response classes
- Implement executor with rollback on failure
- Different from ExecuteMultiple (true transaction semantics)

**Impact:** MEDIUM-HIGH - Enterprise scenarios
**Tests:** Transaction success, rollback scenarios

---

### 4.2 RetrieveMetadataChangesRequest (#538) ⏱️ 4-6 hours
**Status:** PR exists to review
**Files:** New message executor

**Problem:**
No support for metadata change tracking

**Solution:**
Review PR #538 and implement

**Impact:** MEDIUM - Metadata-driven solutions
**Tests:** Metadata tracking scenarios

---

### 4.3 WinQuoteRequest (#510) ⏱️ 2-3 hours
**Status:** PR exists to review
**Files:** New message executor

**Problem:**
No support for converting quotes to orders

**Solution:**
Review PR #510 and implement

**Impact:** LOW-MEDIUM - Sales process testing
**Tests:** Quote conversion

---

### 4.4 Other Missing Messages ⏱️ Variable
**Status:** Ongoing
**From PRs:** Various

Additional message support from PRs:
- RetrieveCurrentOrganizationRequest (#529, #478)
- DeleteRecordChangeHistoryRequest (#542)
- IEntityDataSourceRetrieverService (#572)

**Impact:** Variable
**Priority:** After core improvements

---

## NOT INCLUDED (Future Consideration)

### Elastic Tables Support
**Reason:** Requires significant architecture changes
**Complexity:** Very High
**Timeline:** Separate major version

### Plugin Configuration Download Utility
**Reason:** Requires external tool development
**Complexity:** High
**Timeline:** Separate project

### Metadata Download Utility
**Reason:** Requires external tool development
**Complexity:** High
**Timeline:** Separate project

---

## THIS SESSION: Top 3 Priorities

Based on effort vs impact, implementing NOW:

### 1. ✅ Between Dates Fix (1 hour)
- Simple fix
- High impact
- Low risk

### 2. ✅ Null Reference Fixes (2-4 hours)
- Prevents crashes
- High impact
- Medium risk

### 3. ✅ EntityReference.Name Population (2-3 hours)
- Common use case
- Medium-high impact
- Low risk

**Total: 5-8 hours of focused work**

---

## Success Metrics

After this session:
- ✅ Zero null reference exceptions in query engine
- ✅ Date ranges include full end day
- ✅ EntityReference.Name populated correctly
- ✅ 15+ new tests for improvements
- ✅ Documentation updated

---

## Future Sessions

### Next Up (Phase 2):
- ThisMonth/LastMonth fixes
- Week operator fixes
- UTC timezone support

### Then (Phase 3):
- FetchXML multiple filters
- Left outer joins
- Complex nested queries

### Finally (Phase 4):
- ExecuteTransaction
- RetrieveMetadataChanges
- Additional messages

---

**Note:** This is an ambitious multi-session roadmap. Each phase builds on the previous and delivers immediate value.
